# 🏗️ 项目架构图

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    多平台聊天机器人系统                        │
└─────────────────────────────────────────────────────────────┘

┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Messenger  │    │ Instagram   │    │   网站聊天   │
│   Platform  │    │  Platform   │    │   Web Chat  │
└──────┬──────┘    └──────┬──────┘    └──────┬──────┘
       │                  │                  │
       └──────────────────┼──────────────────┘
                          │
                    ┌─────▼─────┐
                    │  Webhook  │
                    │ Receiver  │
                    └─────┬─────┘
                          │
                    ┌─────▼─────┐
                    │  Express  │
                    │  Server   │
                    └─────┬─────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
   ┌────▼────┐      ┌────▼────┐      ┌────▼────┐
   │  GPT    │      │Session  │      │Knowledge│
   │Service  │      │Service  │      │Service  │
   └────┬────┘      └─────────┘      └────┬────┘
        │                                 │
        │                                 │
   ┌────▼────┐                      ┌────▼────┐
   │ OpenAI  │                      │   FAQ   │
   │   API   │                      │Database │
   └─────────┘                      └─────────┘
```

## 核心模块

### 1. Webhook 接收器 (`src/routes/webhook.js`)
- 处理 Meta 平台的 POST 请求
- 验证请求签名和令牌
- 解析用户消息和事件
- 支持 Messenger 和 Instagram

### 2. GPT 服务 (`src/services/gptService.js`)
- 封装 OpenAI API 调用
- 管理对话历史和上下文
- 生成智能回复
- 处理错误和重试

### 3. 消息发送器 (`src/services/messageSender.js`)
- 调用 Meta Graph API
- 发送文本、快速回复、模板消息
- 处理不同平台的消息格式
- 错误处理和重试机制

### 4. 会话管理 (`src/services/sessionService.js`)
- 管理用户会话状态
- 存储对话历史
- 处理会话过期和清理
- 支持多平台会话

### 5. 知识库服务 (`src/services/knowledgeService.js`)
- 加载和管理 FAQ 数据
- 智能搜索和匹配
- 提供快速回复选项
- 支持分类和优先级

### 6. 网站聊天接口 (`src/routes/chat.js`)
- 提供 RESTful API
- 处理前端聊天请求
- 返回 JSON 格式响应
- 支持会话管理

### 7. 前端聊天界面 (`public/`)
- 响应式聊天 UI
- 实时消息显示
- 快速回复按钮
- 错误处理和加载状态

## 数据流

```
用户消息 → Webhook → GPT服务 → 知识库检索 → 生成回复 → 发送消息
    ↓
会话管理 ← 消息历史 ← 上下文保存 ← 用户状态
```

## 技术栈

### 后端
- **Node.js**: 运行时环境
- **Express.js**: Web 框架
- **OpenAI API**: AI 对话服务
- **Meta Graph API**: 社交平台集成
- **Winston**: 日志管理

### 前端
- **HTML5**: 页面结构
- **CSS3**: 样式设计
- **JavaScript ES6+**: 交互逻辑
- **Font Awesome**: 图标库

### 部署
- **Vercel**: 无服务器部署
- **Docker**: 容器化部署
- **GitHub**: 版本控制

## 安全特性

- ✅ 请求签名验证
- ✅ 速率限制
- ✅ CORS 配置
- ✅ 安全头部
- ✅ 输入验证
- ✅ 错误处理
- ✅ 环境变量保护

## 性能优化

- ✅ 连接池管理
- ✅ 内存缓存
- ✅ 异步处理
- ✅ 错误重试
- ✅ 日志轮转
- ✅ 健康检查

## 监控和日志

- 📊 请求日志记录
- 📈 性能指标监控
- 🚨 错误告警
- 📝 操作审计
- 🔍 调试信息

## 扩展性

- 🔌 插件化架构
- 📱 多平台支持
- 🌐 国际化支持
- 🔄 热重载
- 📦 模块化设计
