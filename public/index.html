<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AcuTherapy Clinic Assistant</title>
<style>
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        margin: 0;
        padding: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }
    .chat-container {width:250px;height:500px;margin:0 auto;background:#fff;border-radius:15px;
        box-shadow:0 10px 25px rgba(0,0,0,0.15);overflow:hidden;display:flex;flex-direction:column;
        position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
    }
    .chat-header {
        background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
        color:white;padding:8px;text-align:center;flex-shrink:0;position:relative;
    }
    .language-switch{
        position:absolute;top:5px;right:5px;background:rgba(255,255,255,0.2);color:white;
        border:1px solid rgba(255,255,255,0.3);padding:2px 6px;border-radius:10px;font-size:8px;
        text-decoration:none;transition:background .3s;
    }
    .language-switch:hover{background:rgba(255,255,255,0.3);}
    .chat-messages{flex:1;overflow-y:auto;padding:8px;background:#f8f9fa;font-size:11px;}
    .message{display:flex;margin-bottom:8px;align-items:flex-start;flex-wrap:wrap;}
    .message-avatar{width:20px;height:20px;border-radius:50%;margin-right:6px;flex-shrink:0;}
    .user-avatar{margin-right:0;margin-left:6px;}
    .message-bubble{max-width:80%;padding:6px 8px;border-radius:10px;word-wrap:break-word;font-size:10px;line-height:1.3;}
    .user-message .message-bubble{background:#667eea;color:#fff;}
    .bot-message .message-bubble{background:#fff;color:#333;border:1px solid #e1e5e9;}
    .quick-replies{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;width:100%;}
    .quick-reply-btn{background:#667eea;color:white;border:none;padding:4px 8px;border-radius:12px;
        cursor:pointer;font-size:9px;transition:background .3s;flex:1;min-width:0;}
    .quick-reply-btn:hover{background:#5a6fd8;}
    .chat-input{padding:6px;background:white;border-top:1px solid #e1e5e9;flex-shrink:0;}
    .input-wrapper{display:flex;gap:4px;}
    .message-input{flex:1;padding:6px 8px;border:1px solid #e1e5e9;border-radius:15px;font-size:10px;outline:none;}
    .message-input:focus{border-color:#667eea;}
    .send-btn{background:#667eea;color:white;border:none;width:25px;height:25px;border-radius:50%;cursor:pointer;font-size:10px;}
    .send-btn:hover{background:#5a6fd8;}
    .send-btn:disabled{background:#ccc;cursor:not-allowed;}
    .loading{text-align:center;color:#666;font-style:italic;width:100%;}
</style>
</head>
<body>
<div class="chat-container">
    <div class="chat-header">
        <a href="/working-chat.html" class="language-switch">‰∏≠Êñá Chinese</a>
        <div class="bot-avatar">
            <img src="https://cdn-icons-png.flaticon.com/512/2785/2785482.png" alt="AcuBot"
                 style="width:60px;height:60px;border-radius:50%;margin-bottom:10px;">
        </div>
        <h1>üåø AcuBot - Your Wellness Guide</h1>
        <p>Online Service | Smart Q&A</p>
    </div>

    <div class="chat-messages" id="chatMessages">
        <!-- ÂàùÂßãÊ¨¢ËøéËØ≠ -->
        <div class="message bot-message">
            <img src="https://cdn-icons-png.flaticon.com/512/4712/4712139.png" class="message-avatar" alt="AcuBot">
            <div class="message-bubble">
                <p>üëã Welcome! I'm AcuBot.</p>
                <p>How can I help you today?</p>
            </div>
        </div>
        <!-- ÂàùÂßãÂø´Êç∑ÈîÆ -->
        <div class="quick-replies" id="initialQuickReplies">
            <button class="quick-reply-btn" onclick="sendQuickReply('appointment_booking')">üìÖ Appointment</button>
            <button class="quick-reply-btn" onclick="sendQuickReply('clinic hours')">üïí Hours</button>
            <button class="quick-reply-btn" onclick="sendQuickReply('clinic location')">üìç Location</button>
        </div>
    </div>

    <div class="chat-input">
        <div class="input-wrapper">
            <input id="messageInput" type="text" class="message-input" placeholder="Type your question..." maxlength="1000">
            <button id="sendBtn" class="send-btn" onclick="sendMessage()">üì§</button>
        </div>
    </div>
</div>

<script>
let isTyping=false;

function addMessage(content,sender,quickReplies=[]){
    const messagesDiv=document.getElementById('chatMessages');

    // ÊûÑÂª∫Ê∂àÊÅØÂùó
    const msg=document.createElement('div');
    msg.className=`message ${sender}-message`;

    const avatar=document.createElement('img');
    avatar.className='message-avatar';
    if(sender==='bot'){avatar.src='https://cdn-icons-png.flaticon.com/512/4712/4712139.png';avatar.alt='AcuBot';}
    else{avatar.src='https://cdn-icons-png.flaticon.com/512/3135/3135715.png';avatar.alt='User';avatar.classList.add('user-avatar');}

    const bubble=document.createElement('div');
    bubble.className='message-bubble';
    bubble.innerHTML=content.replace(/\n/g,'<br>');

    if(sender==='user'){msg.appendChild(bubble);msg.appendChild(avatar);}
    else{msg.appendChild(avatar);msg.appendChild(bubble);}
    messagesDiv.appendChild(msg);

    // Â¶ÇÊûúÊòØ bot ‰∏îÊúâÂø´Êç∑ÈîÆ -> Âú®ËøôÊù°Á≠îÊ°à‰∏ãÊñπÊèíÂÖ•
    if(sender==='bot' && quickReplies.length){
        const qrWrap=document.createElement('div');
        qrWrap.className='quick-replies';
        quickReplies.forEach(opt=>{
            const btn=document.createElement('button');
            btn.className='quick-reply-btn';
            btn.textContent=opt.text;
            btn.onclick=()=>sendQuickReply(opt.query);
            qrWrap.appendChild(btn);
        });
        messagesDiv.appendChild(qrWrap);
    }

    messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

function showLoading(){
    const messagesDiv=document.getElementById('chatMessages');
    const ld=document.createElement('div');
    ld.className='message bot-message';
    ld.id='loadingMsg';
    ld.innerHTML='<div class="message-bubble loading">Thinking...</div>';
    messagesDiv.appendChild(ld);
    messagesDiv.scrollTop=messagesDiv.scrollHeight;
}
function hideLoading(){
    const ld=document.getElementById('loadingMsg');
    if(ld)ld.remove();
}

async function sendMessage(){
    const input=document.getElementById('messageInput');
    const text=input.value.trim();
    if(!text||isTyping)return;

    addMessage(text,'user');
    input.value='';
    showLoading();
    isTyping=true;
    try{
        const res=await fetch('/chat/message-en',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({message:text,userId:'web_en_'+Date.now(),sessionId:'sess_'+Date.now()})
        });
        if(!res.ok)throw new Error('fail');
        const data=await res.json();

        // ÈöèÊú∫ 3 ‰∏™Âø´Êç∑ÈîÆ
        const opts=[
            {text:'üìÖ Book',query:'appointment'},
            {text:'üìã Services',query:'services'},
            {text:'üìç Location',query:'location'},
            {text:'üïí Hours',query:'hours'},
            {text:'üíä Pain Help',query:'back pain'},
            {text:'ü§î Does it hurt?',query:'does acupuncture hurt'},
            {text:'üí∞ Insurance',query:'insurance'},
            {text:'üë®‚Äç‚öïÔ∏è Doctors',query:'doctor team'}
        ];
        const next=opts.sort(()=>0.5-Math.random()).slice(0,3);

        if(data.success){
            addMessage(data.data.message,'bot',next);
        }else{
            addMessage('Sorry, I cannot respond now.','bot');
        }
    }catch(e){
        console.error(e);
        addMessage('Network error, please retry.','bot');
    }finally{
        hideLoading();isTyping=false;
    }
}

function sendQuickReply(text){
    document.getElementById('messageInput').value=text;
    sendMessage();
}

document.getElementById('messageInput').addEventListener('keypress',e=>{
    if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}
});
document.getElementById('messageInput').addEventListener('input',function(){
    document.getElementById('sendBtn').disabled=!this.value.trim()||isTyping;
});
</script>
</body>
</html>
