<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AcuTherapy Clinic Assistant</title>
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .chat-container {
      width: 250px; height: 500px; margin: 0 auto; background: white;
      border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      overflow: hidden; display: flex; flex-direction: column;
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    }
    .chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; padding: 8px; text-align: center; flex-shrink: 0;
      position: relative;
    }
    .chat-header h1 { margin: 2px 0; font-size: 12px; font-weight: 600; }
    .chat-header p { margin: 2px 0; font-size: 9px; }
    .chat-header img {
      width: 25px; height: 25px; border-radius: 50%; margin-bottom: 4px;
    }
    .language-switch {
      position: absolute; top: 5px; right: 5px;
      background: rgba(255,255,255,0.2); color: white;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 2px 6px; border-radius: 10px; text-decoration: none; font-size: 8px;
      transition: background 0.3s;
    }
    .language-switch:hover { background: rgba(255,255,255,0.3); color: white; text-decoration: none; }

    .chat-messages {
      flex: 1; overflow-y: auto; padding: 8px; background: #f8f9fa; min-height: 0; font-size: 11px;
    }
    .message { display: flex; margin-bottom: 8px; align-items: flex-start; }
    .message-avatar { width: 20px; height: 20px; border-radius: 50%; margin-right: 6px; flex-shrink: 0; }
    .user-avatar { margin-right: 0; margin-left: 6px; }
    .user-message { justify-content: flex-end; }
    .bot-message { justify-content: flex-start; }
    .message-bubble {
      max-width: 80%; padding: 6px 8px; border-radius: 10px; word-wrap: break-word;
      font-size: 10px; line-height: 1.3;
    }
    .user-message .message-bubble { background: #667eea; color: white; }
    .bot-message .message-bubble { background: white; color: #333; border: 1px solid #e1e5e9; }

    .quick-replies { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
    .quick-reply-btn {
      background: #667eea; color: white; border: none; padding: 4px 8px; border-radius: 12px;
      cursor: pointer; font-size: 9px; transition: background 0.3s; flex: 1; min-width: 0;
    }
    .quick-reply-btn:hover { background: #5a6fd8; }

    .chat-input { padding: 6px; background: white; border-top: 1px solid #e1e5e9; flex-shrink: 0; }
    .input-wrapper { display: flex; gap: 4px; }
    .message-input {
      flex: 1; padding: 6px 8px; border: 1px solid #e1e5e9; border-radius: 15px; font-size: 10px; outline: none;
    }
    .message-input:focus { border-color: #667eea; }
    .send-btn {
      background: #667eea; color: white; border: none; width: 25px; height: 25px; border-radius: 50%;
      cursor: pointer; font-size: 10px;
    }
    .send-btn:hover { background: #5a6fd8; }
    .send-btn:disabled { background: #ccc; cursor: not-allowed; }
    .loading { text-align: center; color: #666; font-style: italic; }

    /* Mobile */
    @media (max-width: 768px){
      body{padding:5px}
      .chat-container{height:calc(100vh - 10px);border-radius:15px}
      .chat-header{padding:10px}
      .chat-header h1{font-size:18px}
      .chat-header p{font-size:12px}
      .chat-messages{padding:10px}
      .message-bubble{max-width:85%;padding:10px 12px;font-size:14px}
      .chat-input{padding:10px}
      .message-input{padding:10px 14px;font-size:16px}
      .language-switch{font-size:12px;padding:6px 12px}
      .quick-reply-btn{padding:8px 12px;font-size:13px}
    }
    @media (max-width: 480px){
      .chat-header h1{font-size:16px}
      .message-bubble{max-width:90%;padding:8px 10px;font-size:13px}
      .quick-replies{gap:8px}
      .quick-reply-btn{padding:6px 10px;font-size:12px}
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <a href="/working-chat.html" class="language-switch">‰∏≠Êñá Chinese</a>
      <div class="bot-avatar">
        <img src="https://cdn-icons-png.flaticon.com/512/2785/2785482.png" alt="AcuBot" style="width: 60px; height: 60px; border-radius: 50%; margin-bottom: 10px;">
      </div>
      <h1>üåø AcuBot - Your Wellness Guide</h1>
      <p>Online Service | Smart Q&A</p>
    </div>

    <div class="chat-messages" id="chatMessages">
      <div class="message bot-message">
        <img src="https://cdn-icons-png.flaticon.com/512/4712/4712139.png" alt="AcuBot" class="message-avatar">
        <div class="message-bubble">
          <p>üëã Welcome! I'm AcuBot.</p>
          <p>How can I help you today?</p>
        </div>
      </div>

      <!-- First-screen quick replies (no inline onclick; CSP-safe) -->
      <div class="quick-replies" id="quickReplies">
        <button class="quick-reply-btn" data-query="appointment">üìÖ Book Appointment</button>
        <button class="quick-reply-btn" data-query="hours">üïí Hours</button>
        <button class="quick-reply-btn" data-query="location">üìç Location</button>
        <button class="quick-reply-btn" data-query="services">üìã Services</button>
      </div>
    </div>

    <div class="chat-input">
      <div class="input-wrapper">
        <input type="text" id="messageInput" class="message-input" placeholder="Type your question..." maxlength="1000">
        <button id="sendBtn" class="send-btn" onclick="sendMessage()">üì§</button>
      </div>
    </div>
  </div>

<script>
/* ---------- Config: canonical payloads ---------- */
const defaultQuickReplies = [
  { title: 'üìÖ Book Appointment', payload: 'appointment' },
  { title: 'üïí Hours',            payload: 'hours' },
  { title: 'üìç Location',         payload: 'location' },
  { title: 'üìã Services',         payload: 'services' }
];

const extraQuickReplyPool = [
  { title: 'üí∞ Insurance',        payload: 'insurance' },
  { title: 'üíä Pain Help',        payload: 'back pain' },
  { title: 'ü§î Does it hurt?',    payload: 'does acupuncture hurt' },
  { title: 'üë®‚Äç‚öïÔ∏è Doctors',       payload: 'doctor team' },
  { title: 'üìÜ Next openings',    payload: 'availability' },
  { title: 'üßæ Pricing',          payload: 'pricing' }
];

let isTyping = false;

/* ---------- Utilities ---------- */
function shufflePick3(pool){
  return pool.slice().sort(()=>0.5 - Math.random()).slice(0,3);
}
function buildQRButton({title,payload}){
  const btn=document.createElement('button');
  btn.className='quick-reply-btn';
  btn.textContent=title;
  btn.addEventListener('click',()=>sendQuickReply(payload));
  return btn;
}

/* ---------- Renderers ---------- */
function showDefaultQuickReplies(){
  const wrap=document.getElementById('quickReplies');
  if(!wrap) return;
  wrap.innerHTML='';
  defaultQuickReplies.forEach(item=>wrap.appendChild(buildQRButton(item)));
  wrap.style.display='flex';
}

function renderInlineQuickRepliesBelow(messageContainer, list){
  if(!list || list.length===0) return;
  const qrDiv=document.createElement('div');
  qrDiv.className='quick-replies';
  list.forEach(item=>{
    // allow string or {title,payload}
    const data = typeof item==='string' ? {title:item, payload:item} : item;
    qrDiv.appendChild(buildQRButton({title:data.title||data.payload, payload:data.payload||data.title}));
  });
  messageContainer.parentElement.appendChild(qrDiv);
}

/* ---------- Chat flow ---------- */
function addMessage(content, sender, quickRepliesAfter = []){
  const messagesDiv=document.getElementById('chatMessages');

  const row=document.createElement('div');
  row.className=`message ${sender}-message`;

  if(sender==='bot'){
    const avatar=document.createElement('img');
    avatar.className='message-avatar';
    avatar.src='https://cdn-icons-png.flaticon.com/512/4712/4712139.png';
    avatar.alt='AcuBot';
    row.appendChild(avatar);
  }

  const bubble=document.createElement('div');
  bubble.className='message-bubble';
  bubble.innerHTML=String(content||'').replace(/\n/g,'<br>');

  if(sender==='user'){
    // user layout: bubble then avatar (right side)
    row.appendChild(bubble);
    const u=document.createElement('img');
    u.className='message-avatar user-avatar';
    u.src='https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
    u.alt='User';
    row.appendChild(u);
  } else {
    // bot layout: avatar already added
    row.appendChild(bubble);
  }

  messagesDiv.appendChild(row);

  // Hide the top default quick replies only when user sends
  if(sender==='user'){
    const firstQR=document.getElementById('quickReplies');
    if(firstQR) firstQR.style.display='none';
  }

  // If bot ‚Üí append new quick replies right under this answer
  if(sender==='bot' && quickRepliesAfter.length){
    renderInlineQuickRepliesBelow(bubble, quickRepliesAfter);
  }

  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

function showLoading(){
  const messagesDiv=document.getElementById('chatMessages');
  const loadingDiv=document.createElement('div');
  loadingDiv.className='message bot-message';
  loadingDiv.id='loadingMessage';
  loadingDiv.innerHTML='<div class="message-bubble loading">Thinking...</div>';
  messagesDiv.appendChild(loadingDiv);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}
function hideLoading(){
  const loadingDiv=document.getElementById('loadingMessage');
  if(loadingDiv) loadingDiv.remove();
}

async function sendMessage(){
  const input=document.getElementById('messageInput');
  const message=input.value.trim();
  if(!message || isTyping) return;

  addMessage(message,'user');
  input.value='';
  showLoading();
  isTyping=true;

  try{
    const response=await fetch('/chat/message-en',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        message,
        userId:'web_user_en_'+Date.now(),
        sessionId:'session_en_'+Date.now()
      })
    });

    const data=await response.json();
    const nextQR = (data && data.success && Array.isArray(data.data?.quickReplies) && data.data.quickReplies.length)
      ? data.data.quickReplies.map(x => (typeof x==='string' ? {title:x,payload:x} : {title:x.title||x.payload, payload:x.payload||x.title}))
      : shufflePick3(extraQuickReplyPool);

    if(data && data.success){
      addMessage(data.data.message,'bot',nextQR);
    }else{
      addMessage('Sorry, I‚Äôm temporarily unable to respond. Please try again later.','bot',nextQR);
    }
  }catch(err){
    console.error('Failed to send message:', err);
    addMessage('Network issue. Please check your connection and try again.','bot',shufflePick3(extraQuickReplyPool));
  }finally{
    hideLoading();
    isTyping=false;
  }
}

function sendQuickReply(payload){
  const input=document.getElementById('messageInput');
  input.value=payload;
  sendMessage();
}
window.sendQuickReply = sendQuickReply;

/* ---------- Boot ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  // Make first-screen buttons work via event delegation too (CSP-safe)
  const firstQR=document.getElementById('quickReplies');
  if(firstQR){
    firstQR.addEventListener('click', (e)=>{
      const btn = e.target.closest('.quick-reply-btn');
      if(!btn) return;
      const query = btn.dataset.query || btn.textContent.replace(/[üìÖüìãüìçüïíüí∞üíäü§îüë®‚Äç‚öïÔ∏èüìÜüßæ]/g,'').trim().toLowerCase();
      sendQuickReply(query);
    });
  }
  // If you ever want to re-render the top defaults programmatically:
  // showDefaultQuickReplies();
});

document.getElementById('messageInput').addEventListener('keypress', (e)=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
});
document.getElementById('messageInput').addEventListener('input', function(){
  document.getElementById('sendBtn').disabled = !this.value.trim() || isTyping;
});
</script>
</body>
</html>
