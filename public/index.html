<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AcuTherapy Clinic Assistant</title>
  <style>
    /* â€”â€” ä½ çš„æ ·å¼ä¿æŒä¸å˜ â€”â€” */
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;margin:0;padding:10px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;}
    .chat-container{width:250px;height:500px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,.15);overflow:hidden;display:flex;flex-direction:column;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);}
    .chat-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:8px;text-align:center;flex-shrink:0;}
    .chat-header h1{margin:2px 0;font-size:12px;font-weight:600;}
    .chat-header p{margin:2px 0;font-size:9px;}
    .chat-header img{width:25px;height:25px;border-radius:50%;margin-bottom:4px;}
    .chat-messages{flex:1;overflow-y:auto;padding:8px;background:#f8f9fa;min-height:0;font-size:11px;}
    .message{display:flex;margin-bottom:8px;align-items:flex-start;}
    .message-avatar{width:20px;height:20px;border-radius:50%;margin-right:6px;flex-shrink:0;}
    .user-avatar{margin-right:0;margin-left:6px;}
    .user-message{justify-content:flex-end;}
    .bot-message{justify-content:flex-start;}
    .message-bubble{max-width:80%;padding:6px 8px;border-radius:10px;word-wrap:break-word;font-size:10px;line-height:1.3;}
    .user-message .message-bubble{background:#667eea;color:#fff;}
    .bot-message .message-bubble{background:#fff;color:#333;border:1px solid #e1e5e9;}
    .quick-replies{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;}
    .quick-reply-btn{background:#667eea;color:#fff;border:none;padding:4px 8px;border-radius:12px;cursor:pointer;font-size:9px;transition:background .3s;flex:1;min-width:0;}
    .quick-reply-btn:hover{background:#5a6fd8;}
    .chat-input{padding:6px;background:#fff;border-top:1px solid #e1e5e9;flex-shrink:0;}
    .input-wrapper{display:flex;gap:4px;}
    .message-input{flex:1;padding:6px 8px;border:1px solid #e1e5e9;border-radius:15px;font-size:10px;outline:none;}
    .message-input:focus{border-color:#667eea;}
    .send-btn{background:#667eea;color:#fff;border:none;width:25px;height:25px;border-radius:50%;cursor:pointer;font-size:10px;}
    .send-btn:hover{background:#5a6fd8;}
    .send-btn:disabled{background:#ccc;cursor:not-allowed;}
    .loading{text-align:center;color:#666;font-style:italic;}
    .language-switch{position:absolute;top:5px;right:5px;background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3);padding:2px 6px;border-radius:10px;text-decoration:none;font-size:8px;transition:background .3s;}
    .language-switch:hover{background:rgba(255,255,255,.3);color:#fff;text-decoration:none;}
    @media (max-width:768px){body{padding:5px}.chat-container{height:calc(100vh - 10px);border-radius:15px}.chat-header{padding:10px}.chat-header h1{font-size:18px}.chat-header p{font-size:12px}.chat-messages{padding:10px}.message-bubble{max-width:85%;padding:10px 12px;font-size:14px}.chat-input{padding:10px}.message-input{padding:10px 14px;font-size:16px}.language-switch{font-size:12px;padding:6px 12px}.quick-reply-btn{padding:8px 12px;font-size:13px}}
    @media (max-width:480px){.chat-header h1{font-size:16px}.message-bubble{max-width:90%;padding:8px 10px;font-size:13px}.quick-replies{gap:8px}.quick-reply-btn{padding:6px 10px;font-size:12px}}
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <a href="/working-chat.html" class="language-switch">ä¸­æ–‡ Chinese</a>
      <div class="bot-avatar">
        <img src="https://cdn-icons-png.flaticon.com/512/2785/2785482.png" alt="AcuBot" style="width:60px;height:60px;border-radius:50%;margin-bottom:10px;">
      </div>
      <h1>ğŸŒ¿ AcuBot - Your Wellness Guide</h1>
      <p>Online Service | Smart Q&A</p>
    </div>

    <div class="chat-messages" id="chatMessages">
      <div class="message bot-message">
        <img src="https://cdn-icons-png.flaticon.com/512/4712/4712139.png" alt="AcuBot" class="message-avatar">
        <div class="message-bubble">
          <p>ğŸ‘‹ Welcome! I'm AcuBot.</p>
          <p>How can I help you today?</p>
        </div>
      </div>

      <!-- é¦–å±å¿«æ·é”®ï¼šå»æ‰ inline onclickï¼Œæ”¹ç”¨ data-query -->
      <div class="quick-replies" id="quickReplies">
        <button class="quick-reply-btn" data-query="appointment">ğŸ“… Book</button>
        <button class="quick-reply-btn" data-query="hours">ğŸ•’ Hours</button>
        <button class="quick-reply-btn" data-query="location">ğŸ“ Location</button>
      </div>
    </div>

    <div class="chat-input">
      <div class="input-wrapper">
        <input type="text" id="messageInput" class="message-input" placeholder="Type your question..." maxlength="1000">
        <button id="sendBtn" class="send-btn" onclick="sendMessage()">ğŸ“¤</button>
      </div>
    </div>
  </div>

  <script>
    let isTyping = false;

    function getRandomQuickReplies(){
      const all = [
        { text: 'ğŸ’µ Pricing', query: 'pricing' },
        { text: 'ğŸš— Parking', query: 'parking' },
        { text: 'ğŸ“… Book', query: 'appointment' },
        { text: 'ğŸ“‹ Services', query: 'services' },
        { text: 'ğŸ“ Location', query: 'location' },
        { text: 'ğŸ•’ Hours', query: 'hours' },
        { text: 'ğŸ’Š Pain Relief', query: 'back pain' },
        { text: 'ğŸ¤” Does it hurt?', query: 'does acupuncture hurt' },
        { text: 'ğŸ’° Insurance', query: 'insurance' },
        { text: 'ğŸ‘¨â€âš•ï¸ Doctors', query: 'doctors' }
      ];
      return all.sort(()=>0.5-Math.random()).slice(0,3);
    }

    function addMessage(content, sender, quickRepliesAfter = []){
      const messagesDiv = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}-message`;

      const avatar = document.createElement('img');
      avatar.className = 'message-avatar';
      if (sender === 'bot') {
        avatar.src = 'https://cdn-icons-png.flaticon.com/512/4712/4712139.png';
        avatar.alt = 'AcuBot';
      } else {
        avatar.src = 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
        avatar.alt = 'User';
        avatar.classList.add('user-avatar');
      }

      const bubbleDiv = document.createElement('div');
      bubbleDiv.className = 'message-bubble';
      bubbleDiv.innerHTML = content.replace(/\n/g,'<br>');

      if (sender === 'user') { messageDiv.appendChild(bubbleDiv); messageDiv.appendChild(avatar); }
      else { messageDiv.appendChild(avatar); messageDiv.appendChild(bubbleDiv); }

      messagesDiv.appendChild(messageDiv);

      // ç”¨æˆ·å‘æ¶ˆæ¯ -> éšè—é¦–å±æŒ‰é’®
      if (sender === 'user') {
        const firstQR = document.getElementById('quickReplies');
        if (firstQR) firstQR.style.display = 'none';
      }

      // bot å›å¤ -> åœ¨ç­”æ¡ˆä¸‹æ–¹æ’å…¥æ–°å¿«æ·é”®
      if (sender === 'bot' && quickRepliesAfter.length){
        const wrap = document.createElement('div');
        wrap.className = 'quick-replies';
        quickRepliesAfter.forEach(opt=>{
          const btn = document.createElement('button');
          btn.className = 'quick-reply-btn';
          btn.textContent = opt.text;
          btn.addEventListener('click', ()=> sendQuickReply(opt.query));
          wrap.appendChild(btn);
        });
        messagesDiv.appendChild(wrap);
      }
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showLoading(){
      const messagesDiv = document.getElementById('chatMessages');
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'message bot-message';
      loadingDiv.id = 'loadingMessage';
      loadingDiv.innerHTML = '<div class="message-bubble loading">Thinking...</div>';
      messagesDiv.appendChild(loadingDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    function hideLoading(){
      const loadingDiv = document.getElementById('loadingMessage');
      if (loadingDiv) loadingDiv.remove();
    }

    async function sendMessage(){
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      if (!message || isTyping) return;

      addMessage(message,'user');
      input.value = '';
      showLoading();
      isTyping = true;

      try{
        const res = await fetch('/chat/message-en',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            message,
            userId:'web_user_en_'+Date.now(),
            sessionId:'session_en_'+Date.now()
          })
        });
        const data = await res.json();
        const nextQR = getRandomQuickReplies();
        if (data && data.success){
          addMessage(data.data.message,'bot',nextQR);
        } else {
          addMessage('Sorry, I am temporarily unable to respond to your message. Please try again later.','bot',nextQR);
        }
      }catch(err){
        console.error('send error',err);
        addMessage('Sorry, there was a network connection issue. Please check your connection and try again.','bot',getRandomQuickReplies());
      }finally{
        hideLoading();
        isTyping = false;
      }
    }

    function sendQuickReply(text){
      const input = document.getElementById('messageInput');
      input.value = text;
      sendMessage();
    }
    // æå‰æŒ‚åˆ°å…¨å±€ï¼Œé¿å…æ‰¾ä¸åˆ°
    window.sendQuickReply = sendQuickReply;

    // âœ… é¦–å±æŒ‰é’®ç”¨äº‹ä»¶å§”æ‰˜ï¼ˆä¸ä¾èµ– inline onclickï¼Œä¹Ÿä¸å— CSP å½±å“ï¼‰
    document.addEventListener('DOMContentLoaded', ()=>{
      const qr = document.getElementById('quickReplies');
      if (qr){
        qr.addEventListener('click',(e)=>{
          const btn = e.target.closest('.quick-reply-btn');
          if (!btn) return;
          const q = btn.dataset.query || btn.textContent.trim();
          sendQuickReply(q);
        });
      }
    });

    // å‘é€å¿«æ·é”®/å›è½¦å‘é€
    document.getElementById('messageInput').addEventListener('keypress', (e)=>{
      if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
    });
    document.getElementById('messageInput').addEventListener('input', function(){
      document.getElementById('sendBtn').disabled = !this.value.trim() || isTyping;
    });
  
  // ğŸ”¹ Q&A å­—å…¸ï¼šå¿«æ·é”® query => æ ‡å‡†ç­”æ¡ˆ
  // Q&A dictionary
const QA_DICTIONARY = {
  "appointment": "ğŸ“… You can book an appointment online here: https://acutherapy.janeapp.com or call us at (808) 528-7177.",
  "hours": "ğŸ•’ Our clinic hours are: Mondayâ€“Saturday 9:00 AM â€“ 1:00 PM.",
  "location": "ğŸ“ Main clinic: 1650 Liliha St, Suite 208, Honolulu. Free parking available.",
  "pricing": "ğŸ’µ Most sessions range between $85â€“$180 depending on insurance.",
  "parking": "ğŸš— Free parking at both clinics. Liliha = private lot. Aiea = plaza parking.",
  "services": "ğŸ“‹ We offer acupuncture, cupping, massage, and holistic rehab.",
  "back pain": "ğŸ’Š We treat lower/upper back pain, chronic pain, sciatica, and tension. Call (808) 528-7177.",
  "does acupuncture hurt": "ğŸ¤” Most patients feel only a tiny pinch. Many find it relaxing.",
  "insurance": "ğŸ’° We accept Auto, Workers Comp, HMSA, Kaiser, UHA, VA, TriWest. Call us to confirm.",
  "doctors": "ğŸ‘¨â€âš•ï¸ Our licensed acupuncturists have 30+ years of experience."
};

// Only one sendQuickReply
function sendQuickReply(query) {
  const answer = QA_DICTIONARY[query.toLowerCase()];
  if (answer) {
    addMessage(answer, "bot", getRandomQuickReplies());
  } else {
    // fallback to AI
    document.getElementById('messageInput').value = query;
    sendMessage();
  }
}
window.sendQuickReply = sendQuickReply;
// âœ… Ensure send button works
document.addEventListener('DOMContentLoaded', () => {
  const sendBtn = document.getElementById('sendBtn');
  if (sendBtn) {
    sendBtn.addEventListener('click', () => {
      sendMessage();
    });
  }
});
let FAQ_DATA = [];

// åŠ è½½ FAQ JSON
async function loadFAQ() {
  try {
    const res = await fetch('/data/faq.json');
    const json = await res.json();
    FAQ_DATA = json.faq || [];
    console.log("FAQ loaded", FAQ_DATA.length);
  } catch (err) {
    console.error('Failed to load FAQ:', err);
  }
}

// åŒ¹é…å‡½æ•°
function findFAQAnswer(query) {
  const lower = query.toLowerCase();

  for (let item of FAQ_DATA) {
    if (item.id.toLowerCase() === lower) return item.answer;
    if (item.keywords && item.keywords.some(k => lower.includes(k.toLowerCase()))) {
      return item.answer;
    }
  }
  return null; // æ²¡å‘½ä¸­ â†’ fallback AI
}

// ä¿®æ”¹ sendMessageï¼šå…ˆæŸ¥ FAQ
async function sendMessage() {
  const input = document.getElementById('messageInput');
  const message = input.value.trim();
  if (!message || isTyping) return;

  addMessage(message, 'user');
  input.value = '';

  const faqAnswer = findFAQAnswer(message);
  if (faqAnswer) {
    addMessage(faqAnswer, "bot", getRandomQuickReplies());
    return;
  }

  // fallback AI
  showLoading();
  isTyping = true;
  try {
    const res = await fetch('/chat/message-en', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message, userId:'web_user_en_'+Date.now(), sessionId:'session_en_'+Date.now() })
    });
    const data = await res.json();
    if (data && data.success) {
      addMessage(data.data.message, 'bot', getRandomQuickReplies());
    } else {
      addMessage('Sorry, I am temporarily unable to respond.', 'bot', getRandomQuickReplies());
    }
  } catch (err) {
    console.error(err);
    addMessage('Network error, please try again later.', 'bot', getRandomQuickReplies());
  } finally {
    hideLoading();
    isTyping = false;
  }
}

// åˆå§‹åŒ–åŠ è½½
document.addEventListener('DOMContentLoaded', loadFAQ);

</script>

</body>
</html>

