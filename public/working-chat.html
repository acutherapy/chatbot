<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>诊所客服助手</title>
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .chat-container {
      width: 250px;
      height: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 8px;
      text-align: center;
      flex-shrink: 0;
    }
    .language-switch {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 8px;
      text-decoration: none;
      transition: background 0.3s;
    }
    .language-switch:hover { background: rgba(255,255,255,0.3); }
    .chat-header h1 { margin: 2px 0; font-size: 12px; font-weight: 600; }
    .chat-header p { margin: 2px 0; font-size: 9px; }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      background: #f8f9fa;
      font-size: 11px;
    }
    .message {
      display: flex;
      margin-bottom: 8px;
      align-items: flex-start;
    }
    .message-avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 6px;
      flex-shrink: 0;
    }
    .user-avatar { margin-left: 6px; margin-right: 0; }
    .user-message { justify-content: flex-end; }
    .bot-message { justify-content: flex-start; }
    .message-bubble {
      max-width: 80%;
      padding: 6px 8px;
      border-radius: 10px;
      word-wrap: break-word;
      font-size: 10px;
      line-height: 1.3;
    }
    .user-message .message-bubble { background: #667eea; color: white; }
    .bot-message .message-bubble { background: white; color: #333; border: 1px solid #e1e5e9; }
    .quick-replies {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }
    .quick-reply-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 9px;
      transition: background 0.3s;
      flex: 1;
      min-width: 0;
    }
    .quick-reply-btn:hover { background: #5a6fd8; }
    .chat-input {
      padding: 6px;
      background: white;
      border-top: 1px solid #e1e5e9;
      flex-shrink: 0;
    }
    .input-wrapper { display: flex; gap: 4px; }
    .message-input {
      flex: 1;
      padding: 6px 8px;
      border: 1px solid #e1e5e9;
      border-radius: 15px;
      font-size: 10px;
      outline: none;
    }
    .message-input:focus { border-color: #667eea; }
    .send-btn {
      background: #667eea;
      color: white;
      border: none;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 10px;
    }
    .send-btn:hover { background: #5a6fd8; }
    .send-btn:disabled { background: #ccc; cursor: not-allowed; }
    .loading { text-align: center; color: #666; font-style: italic; }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <a href="/index.html" class="language-switch">English</a>
      <img src="https://cdn-icons-png.flaticon.com/512/2785/2785482.png"
           alt="灸宝宝" style="width:60px;height:60px;border-radius:50%;margin-bottom:8px;">
      <h1>🌿 灸宝宝 - 您的健康向导</h1>
      <p>在线服务 | 智能问答</p>
    </div>

    <div class="chat-messages" id="chatMessages">
      <div class="message bot-message">
        <img src="https://cdn-icons-png.flaticon.com/512/4712/4712139.png" alt="bot" class="message-avatar">
        <div class="message-bubble">
          👋 欢迎来到我们的诊所！<br>我是灸宝宝，可以为您提供：
          <ul>
            <li>📋 服务咨询</li>
            <li>📅 预约安排</li>
            <li>🏥 诊所信息</li>
            <li>💡 健康建议</li>
          </ul>
          请告诉我您需要什么帮助？
        </div>
      </div>
      <div class="quick-replies" id="quickReplies">
        <button class="quick-reply-btn" onclick="sendQuickReply('预约服务')">📅 预约服务</button>
        <button class="quick-reply-btn" onclick="sendQuickReply('营业时间')">🕒 营业时间</button>
        <button class="quick-reply-btn" onclick="sendQuickReply('诊所地址')">📍 诊所地址</button>
      </div>
    </div>

    <div class="chat-input">
      <div class="input-wrapper">
        <input type="text" id="messageInput" class="message-input" placeholder="请输入您的问题..." maxlength="1000">
        <button id="sendBtn" class="send-btn" onclick="sendMessage()">📤</button>
      </div>
    </div>
  </div>

<script>
let isTyping = false;

function addMessage(content, sender, qrs = []) {
  const wrap = document.getElementById('chatMessages');
  const box = document.createElement('div');
  box.className = `message ${sender}-message`;

  const bubble = document.createElement('div');
  bubble.className = 'message-bubble';
  bubble.innerHTML = content.replace(/\n/g,'<br>');
  if (sender === 'bot') {
    const avatar = document.createElement('img');
    avatar.src = 'https://cdn-icons-png.flaticon.com/512/4712/4712139.png';
    avatar.className='message-avatar';
    box.appendChild(avatar);
    box.appendChild(bubble);
  } else {
    bubble.style.marginRight='6px';
    box.appendChild(bubble);
  }
  wrap.appendChild(box);

  // 新快捷键（仅 bot 回复时）
  if(sender==='bot' && qrs.length>0){
    const qrDiv=document.createElement('div');
    qrDiv.className='quick-replies';
    qrs.forEach(item=>{
      const btn=document.createElement('button');
      btn.className='quick-reply-btn';
      btn.textContent=item.title||item;
      btn.onclick=()=>sendQuickReply(item.payload||item.title||item);
      qrDiv.appendChild(btn);
    });
    wrap.appendChild(qrDiv);
  }
  wrap.scrollTop=wrap.scrollHeight;
}

function showLoading(){
  const w=document.getElementById('chatMessages');
  const ld=document.createElement('div');
  ld.id='loading';
  ld.className='message bot-message';
  ld.innerHTML='<div class="message-bubble loading">正在思考中...</div>';
  w.appendChild(ld);
  w.scrollTop=w.scrollHeight;
}
function hideLoading(){
  const ld=document.getElementById('loading');
  if(ld) ld.remove();
}

async function sendMessage(){
  const input=document.getElementById('messageInput');
  const msg=input.value.trim();
  if(!msg||isTyping)return;
  addMessage(msg,'user');
  input.value='';
  showLoading(); isTyping=true;
  try{
    const r=await fetch('/chat/message',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({message:msg,userId:'web_cn_'+Date.now(),sessionId:'session_cn_'+Date.now()})
    });
    const d=await r.json();
    if(d.success){
      addMessage(d.data.message,'bot',d.data.quickReplies||[]);
    }else{
      addMessage('抱歉，暂时无法回复，请稍后再试。','bot');
    }
  }catch(e){
    console.error(e);
    addMessage('网络错误，请稍后再试。','bot');
  }finally{ hideLoading(); isTyping=false;}
}

function sendQuickReply(txt){
  document.getElementById('messageInput').value=txt;
  sendMessage();
}
window.sendQuickReply=sendQuickReply;

// 初始按钮事件委托
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('quickReplies').addEventListener('click',e=>{
    if(e.target.classList.contains('quick-reply-btn')){
      sendQuickReply(e.target.textContent.replace(/[📅📍🕒📋]/g,'').trim());
    }
  });
});

document.getElementById('messageInput').addEventListener('keypress',e=>{
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}
});
document.getElementById('messageInput').addEventListener('input',function(){
  document.getElementById('sendBtn').disabled=!this.value.trim()||isTyping;
});
</script>
</body>
</html>
