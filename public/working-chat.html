<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>诊所客服助手 - 工作版本</title>
  <style>
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;margin:0;padding:10px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;}
    .chat-container{width:250px;height:500px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,.15);overflow:hidden;display:flex;flex-direction:column;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);}
    .chat-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:8px;text-align:center;flex-shrink:0;}
    .language-switch{position:absolute;top:5px;right:5px;background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3);padding:2px 6px;border-radius:10px;text-decoration:none;font-size:8px;transition:background .3s;}
    .language-switch:hover{background:rgba(255,255,255,.3);}
    .chat-header h1{margin:2px 0;font-size:12px;font-weight:600;}
    .chat-header p{margin:2px 0;font-size:9px;}
    .chat-messages{height:380px;overflow-y:auto;padding:8px;background:#f8f9fa;flex:1;}
    .message{display:flex;margin-bottom:6px;align-items:flex-start;}
    .user-message{justify-content:flex-end;}
    .bot-message{justify-content:flex-start;}
    .message-bubble{max-width:80%;padding:6px 8px;border-radius:10px;word-wrap:break-word;font-size:9px;line-height:1.2;}
    .user-message .message-bubble{background:#667eea;color:#fff;}
    .bot-message .message-bubble{background:#fff;color:#333;border:1px solid #e1e5e9;}
    .quick-replies{display:flex;flex-wrap:wrap;gap:3px;margin-top:4px;}
    .quick-reply-btn{background:#667eea;color:#fff;border:none;padding:3px 6px;border-radius:8px;cursor:pointer;font-size:7px;transition:background .3s;}
    .quick-reply-btn:hover{background:#5a6fd8;}
    .chat-input{padding:8px;background:#fff;border-top:1px solid #e1e5e9;flex-shrink:0;}
    .input-wrapper{display:flex;gap:4px;}
    .message-input{flex:1;padding:6px 8px;border:1px solid #e1e5e9;border-radius:12px;font-size:9px;outline:none;}
    .message-input:focus{border-color:#667eea;}
    .send-btn{background:#667eea;color:#fff;border:none;width:24px;height:24px;border-radius:50%;cursor:pointer;font-size:8px;}
    .send-btn:hover{background:#5a6fd8;}
    .send-btn:disabled{background:#ccc;cursor:not-allowed;}
    .loading{text-align:center;color:#666;font-style:italic;}
  </style>
</head>
<body>
<div class="chat-container">
  <div class="chat-header">
    <!-- 英文链接回首页 -->
    <a href="/index.html" class="language-switch">English</a>
    <div class="bot-avatar">
      <img src="https://cdn-icons-png.flaticon.com/512/2785/2785482.png"
           alt="针灸助手"
           style="width:60px;height:60px;border-radius:50%;margin-bottom:10px;">
    </div>
    <h1>🌿 灸宝宝 - 您的健康向导</h1>
    <p>在线服务 | 智能问答</p>
  </div>

  <div class="chat-messages" id="chatMessages">
    <div class="message bot-message">
      <div class="message-bubble">
        <p>👋 欢迎来到我们的诊所！</p>
        <p>我是针灸助手，您的专属健康向导，可以为您提供：</p>
        <ul>
          <li>📋 服务咨询</li>
          <li>📅 预约安排</li>
          <li>🏥 诊所信息</li>
          <li>💡 健康建议</li>
        </ul>
        <p>请告诉我您需要什么帮助？</p>
      </div>
    </div>

    <!-- 首页快捷键 -->
    <div class="quick-replies" id="quickReplies">
      <button class="quick-reply-btn" data-query="预约服务">📅 预约服务</button>
      <button class="quick-reply-btn" data-query="查看服务">📋 查看服务</button>
      <button class="quick-reply-btn" data-query="诊所地址">📍 诊所信息</button>
      <button class="quick-reply-btn" data-query="营业时间">🕒 营业时间</button>
    </div>
  </div>

  <div class="chat-input">
    <div class="input-wrapper">
      <input type="text" id="messageInput" class="message-input" placeholder="请输入您的问题..." maxlength="1000">
      <button id="sendBtn" class="send-btn" onclick="sendMessage()">📤</button>
    </div>
  </div>
</div>

<script>
let isTyping=false;

function addMessage(content,sender){
  const box=document.createElement('div');
  box.className=`message ${sender}-message`;
  const bubble=document.createElement('div');
  bubble.className='message-bubble';
  bubble.innerHTML=content.replace(/\n/g,'<br>');
  box.appendChild(bubble);
  document.getElementById('chatMessages').appendChild(box);
  if(sender==='user'){document.getElementById('quickReplies').style.display='none';}
  document.getElementById('chatMessages').scrollTop=document.getElementById('chatMessages').scrollHeight;
}

function showLoading(){
  const ld=document.createElement('div');
  ld.className='message bot-message';
  ld.id='loadingMessage';
  ld.innerHTML='<div class="message-bubble loading">正在思考中...</div>';
  document.getElementById('chatMessages').appendChild(ld);
}
function hideLoading(){const l=document.getElementById('loadingMessage');if(l)l.remove();}

async function sendMessage(){
  const input=document.getElementById('messageInput');
  const msg=input.value.trim();
  if(!msg||isTyping)return;
  addMessage(msg,'user');input.value='';showLoading();isTyping=true;
  try{
    const res=await fetch('/chat/message',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg,userId:'web_cn_'+Date.now(),sessionId:'session_cn_'+Date.now()})});
    const data=await res.json();
    if(data.success){addMessage(data.data.message,'bot');if(data.data.quickReplies)renderQuickReplies(data.data.quickReplies);else renderDefaultQR();}
    else addMessage('抱歉，我暂时无法回复，请稍后再试。','bot');
  }catch(e){console.error(e);addMessage('网络错误，请稍后再试。','bot');}
  finally{hideLoading();isTyping=false;}
}

function sendQuickReply(text){document.getElementById('messageInput').value=text;sendMessage();}
window.sendQuickReply=sendQuickReply;

function renderQuickReplies(list){
  const wrap=document.getElementById('quickReplies');
  wrap.innerHTML='';
  list.forEach(item=>{
    const btn=document.createElement('button');
    btn.className='quick-reply-btn';
    btn.textContent=item.title||item;
    btn.addEventListener('click',()=>sendQuickReply(item.payload||item.title||item));
    wrap.appendChild(btn);
  });
  wrap.style.display='flex';
}
function renderDefaultQR(){
  const wrap=document.getElementById('quickReplies');
  wrap.innerHTML=`<button class="quick-reply-btn" data-query="营业时间">🕒 营业时间</button>
                  <button class="quick-reply-btn" data-query="预约服务">📅 预约服务</button>
                  <button class="quick-reply-btn" data-query="诊所地址">📍 诊所地址</button>`;
  wrap.style.display='flex';
}

document.addEventListener('DOMContentLoaded',()=>{
  renderDefaultQR();
  document.getElementById('quickReplies').addEventListener('click',e=>{
    const btn=e.target.closest('.quick-reply-btn');
    if(btn)sendQuickReply(btn.dataset.query||btn.textContent.replace(/[📅📋📍🕒]/g,'').trim());
  });
});
document.getElementById('messageInput').addEventListener('keypress',e=>{
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}
});
document.getElementById('messageInput').addEventListener('input',function(){
  document.getElementById('sendBtn').disabled=!this.value.trim()||isTyping;
});
</script>
</body>
</html>
